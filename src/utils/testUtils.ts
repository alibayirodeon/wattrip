import { testVehicles, testRoutes, testChargingStations } from './testData';
import { generateChargingPlan } from './chargingPlanCalculator';
import { calculateSegmentEnergy } from './energyCalculator';
import { getElevationForPolyline } from './elevationService';
import { 
  TestSegment, 
  TestPoint, 
  ChargingPlanResult, 
  ChargingStop, 
  EnergyCalculationParams,
  ChargingPlanParams 
} from '../types/test';

// Enerji hesaplama testi
const testEnergyCalculation = async () => {
  console.log('üîã Enerji Hesaplama Testi Ba≈ülƒ±yor...');
  
  try {
    for (const route of testRoutes) {
      console.log(`\nüìç Rota: ${route.polylinePoints[0].latitude},${route.polylinePoints[0].longitude} -> ${route.polylinePoints[1].latitude},${route.polylinePoints[1].longitude}`);
      
      for (const vehicle of testVehicles) {
        console.log(`\nüöó Ara√ß: ${vehicle.brand} ${vehicle.model}`);
        
        try {
          // Segment enerjilerini hesapla
          const segmentEnergies = await Promise.all(
            route.elevationData.map(async (segment: TestSegment, index: number) => {
              const params: EnergyCalculationParams = {
                speed: 100, // km/s
                temperature: 20, // ¬∞C
                load: 0, // kg
                isHighway: true
              };
              // Segment deƒüerlerini logla
              console.log(`Segment ${index + 1} mesafe:`, segment.distance, 'eƒüim:', segment.elevation);
              const energy = calculateSegmentEnergy(segment.distance, segment.elevation, vehicle, params);
              if (isNaN(energy)) {
                console.warn(`NaN enerji! Segment ${index + 1}: distance=${segment.distance}, elevation=${segment.elevation}, vehicle=`, vehicle);
              }
              return energy;
            })
          );
          
          // Sonu√ßlarƒ± g√∂ster
          console.log('üìä Segment Enerjileri:');
          segmentEnergies.forEach((energy: number, index: number) => {
            console.log(`  Segment ${index + 1}: ${energy.toFixed(2)} kWh`);
          });
          
          // Toplam enerji
          const totalEnergy = segmentEnergies.reduce((sum: number, energy: number) => sum + energy, 0);
          console.log(`\n‚ö° Toplam Enerji: ${totalEnergy.toFixed(2)} kWh`);
          
          // Beklenen menzil
          const expectedRange = (vehicle.batteryCapacity / totalEnergy) * route.distance;
          console.log(`üéØ Beklenen Menzil: ${expectedRange.toFixed(2)} km`);
        } catch (error) {
          console.error(`‚ùå Ara√ß testi sƒ±rasƒ±nda hata: ${vehicle.brand} ${vehicle.model}`, error);
        }
      }
    }
  } catch (error) {
    console.error('‚ùå Enerji hesaplama testi sƒ±rasƒ±nda hata:', error);
    throw error;
  }
};

// ≈ûarj planƒ± testi
const testChargingPlan = async () => {
  console.log('\nüîå ≈ûarj Planƒ± Testi Ba≈ülƒ±yor...');
  
  try {
    for (const route of testRoutes) {
      console.log(`\nüìç Rota: ${route.polylinePoints[0].latitude},${route.polylinePoints[0].longitude} -> ${route.polylinePoints[1].latitude},${route.polylinePoints[1].longitude}`);
      
      for (const vehicle of testVehicles) {
        console.log(`\nüöó Ara√ß: ${vehicle.brand} ${vehicle.model}`);
        
        try {
          if (!vehicle) {
            console.error('Ara√ß undefined! Test verisi veya fonksiyon √ßaƒürƒ±sƒ± hatalƒ±.');
          }
          const params: ChargingPlanParams = {
            startBatteryPercent: 100,
            targetBatteryPercent: 20,
            minBatteryPercent: 10,
            maxBatteryPercent: 80,
            temperature: 20,
            load: 0,
            isHighway: true
          };
          
          // ≈ûarj planƒ± olu≈ütur
          const plan: ChargingPlanResult = await generateChargingPlan({
            selectedVehicle: vehicle,
            routeData: {
              distance: route.distance,
              polylinePoints: route.polylinePoints
            },
            chargingStations: testChargingStations
          });
          
          // Sonu√ßlarƒ± g√∂ster
          console.log('\nüìã ≈ûarj Planƒ±:');
          const lastStop = plan.chargingStops.length > 0 ? plan.chargingStops[plan.chargingStops.length-1] : null;
          const totalDistance = lastStop ? lastStop.distanceFromStartKm : 0;
          console.log(`Toplam Mesafe: ${totalDistance.toFixed(2)} km`);
          console.log(`Toplam S√ºre: ${plan.totalChargingTimeMinutes.toFixed(0)} dakika`);
          console.log(`Toplam Enerji: ${plan.totalEnergyConsumedKWh.toFixed(2)} kWh`);
          
          console.log('\nüõë ≈ûarj Duraklarƒ±:');
          plan.chargingStops.forEach((stop: ChargingStop, index: number) => {
            console.log(`\n  Durak ${index + 1}: ${stop.name}`);
            console.log(`  Mesafe: ${stop.distanceFromStartKm} km`);
            console.log(`  Batarya: %${stop.batteryBeforeStopPercent} -> %${stop.batteryAfterStopPercent}`);
            console.log(`  ≈ûarj Enerjisi: ${stop.energyChargedKWh} kWh`);
            console.log(`  ≈ûarj S√ºresi: ${stop.estimatedChargeTimeMinutes} dakika`);
            console.log(`  ƒ∞stasyon G√ºc√º: ${stop.stationPowerKW} kW`);
            console.log(`  Ortalama G√º√ß: ${stop.averageChargingPowerKW} kW`);
            console.log(`  Verimlilik: %${stop.chargingEfficiency}`);
          });
          
          if (plan.warnings.length > 0) {
            console.log('\n‚ö†Ô∏è Uyarƒ±lar:');
            plan.warnings.forEach(warning => console.log(`  ${warning}`));
          }
        } catch (error) {
          console.error(`‚ùå Ara√ß ≈üarj planƒ± testi sƒ±rasƒ±nda hata: ${vehicle.brand} ${vehicle.model}`, error);
        }
      }
    }
  } catch (error) {
    console.error('‚ùå ≈ûarj planƒ± testi sƒ±rasƒ±nda hata:', error);
    throw error;
  }
};

// Y√ºkseklik verisi testi
const testElevationData = async () => {
  console.log('\n‚õ∞Ô∏è Y√ºkseklik Verisi Testi Ba≈ülƒ±yor...');
  
  try {
    for (const route of testRoutes) {
      console.log(`\nüìç Rota: ${route.polylinePoints[0].latitude},${route.polylinePoints[0].longitude} -> ${route.polylinePoints[1].latitude},${route.polylinePoints[1].longitude}`);
      
      try {
        // Y√ºkseklik verilerini al
        const elevationData: TestPoint[] = await getElevationForPolyline(route.polylinePoints);
        
        // Sonu√ßlarƒ± g√∂ster
        console.log('\nüìä Y√ºkseklik Verileri:');
        elevationData.forEach((point: TestPoint, index: number) => {
          console.log(`  Nokta ${index + 1}: ${point.elevation} m (${point.distance} km)`);
        });
        
        // Y√ºkseklik deƒüi≈üimi
        const elevationChange = elevationData[elevationData.length - 1].elevation - elevationData[0].elevation;
        console.log(`\nüìà Toplam Y√ºkseklik Deƒüi≈üimi: ${elevationChange} m`);
      } catch (error) {
        console.error(`‚ùå Rota y√ºkseklik verisi testi sƒ±rasƒ±nda hata: ${route.polylinePoints[0].latitude},${route.polylinePoints[0].longitude} -> ${route.polylinePoints[1].latitude},${route.polylinePoints[1].longitude}`, error);
      }
    }
  } catch (error) {
    console.error('‚ùå Y√ºkseklik verisi testi sƒ±rasƒ±nda hata:', error);
    throw error;
  }
};

// T√ºm testleri √ßalƒ±≈ütƒ±r
export const runAllTests = async () => {
  console.log('üß™ WatTrip Test Suite Ba≈ülƒ±yor...\n');
  
  try {
    await testEnergyCalculation();
    await testChargingPlan();
    await testElevationData();
    
    console.log('\n‚úÖ T√ºm testler ba≈üarƒ±yla tamamlandƒ±!');
  } catch (error) {
    console.error('\n‚ùå Test sƒ±rasƒ±nda hata olu≈ütu:', error);
    if (error instanceof Error) {
      console.error('Hata detayƒ±:', error.message);
      console.error('Hata stack:', error.stack);
    }
    throw error;
  }
};

// Diƒüer test fonksiyonlarƒ±nƒ± da export et
export {
  testEnergyCalculation,
  testChargingPlan,
  testElevationData
};

// Geli≈ümi≈ü Test Suite
export const runAdvancedTestSuite = async () => {
  console.log('\nüö¶ Geli≈ümi≈ü Test Suite Ba≈ülƒ±yor...');
  const defaultParams = {
    startBatteryPercent: 50,
    targetBatteryPercent: 20,
    minBatteryPercent: 10,
    maxBatteryPercent: 80,
    temperature: 20,
    load: 0,
    isHighway: true
  };

  // 1. Kritik E≈üik Testleri
  console.log('\n[1] Kritik E≈üik Testleri');
  for (const vehicle of testVehicles) {
    const route = testRoutes[0];
    // %19 SOC ile ba≈ülat
    const lowSOCParams = { ...defaultParams, startBatteryPercent: 19 };
    const planLowSOC = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: route.distance, polylinePoints: route.polylinePoints },
      chargingStations: testChargingStations,
      startChargePercent: 19
    });
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - %19 SOC ile ba≈ülatƒ±ldƒ±, Uyarƒ±lar:`, planLowSOC.warnings);
    // %81 hedef SOC
    const highSOCParams = { ...defaultParams, maxBatteryPercent: 81 };
    const planHighSOC = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: route.distance, polylinePoints: route.polylinePoints },
      chargingStations: testChargingStations,
      startChargePercent: 50
    });
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - %81 hedef SOC, Uyarƒ±lar:`, planHighSOC.warnings);
  }

  // 2. Yoku≈ü T√ºketimi Ger√ßekliƒüi
  console.log('\n[2] Yoku≈ü T√ºketimi Ger√ßekliƒüi');
  const flatRoute = { ...testRoutes[0], elevationData: testRoutes[0].elevationData.map(seg => ({ ...seg, elevation: 0 })) };
  const hillyRoute = testRoutes[0];
  for (const vehicle of testVehicles) {
    const flatEnergy = flatRoute.elevationData.reduce((sum, seg) => sum + calculateSegmentEnergy(seg.distance, seg.elevation, vehicle, defaultParams), 0);
    const hillyEnergy = hillyRoute.elevationData.reduce((sum, seg) => sum + calculateSegmentEnergy(seg.distance, seg.elevation, vehicle, defaultParams), 0);
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - D√ºz: ${flatEnergy.toFixed(2)} kWh, Yoku≈ülu: ${hillyEnergy.toFixed(2)} kWh`);
  }

  // 3. Rejeneratif Frenleme Onayƒ±
  console.log('\n[3] Rejeneratif Frenleme Onayƒ±');
  for (const vehicle of testVehicles) {
    for (const seg of hillyRoute.elevationData) {
      const energy = calculateSegmentEnergy(seg.distance, seg.elevation < 0 ? -Math.abs(seg.elevation) : seg.elevation, vehicle, defaultParams);
      if (energy < 0) {
        console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Rejen aktif! Segment: distance=${seg.distance}, elevation=${seg.elevation}, enerji=${energy.toFixed(2)} kWh`);
      }
    }
  }

  // 4. ≈ûarj Altyapƒ±sƒ± Sƒ±nƒ±rlƒ± Testi
  console.log('\n[4] ≈ûarj Altyapƒ±sƒ± Sƒ±nƒ±rlƒ± Testi');
  for (const vehicle of testVehicles) {
    const planNoStations = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: testRoutes[0].distance, polylinePoints: testRoutes[0].polylinePoints },
      chargingStations: []
    });
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - ƒ∞stasyon yok, Uyarƒ±lar:`, planNoStations.warnings);
  }

  // 5. Ara√ßlara √ñzel Farklƒ±lƒ±k
  console.log('\n[5] Ara√ßlara √ñzel Farklƒ±lƒ±k');
  for (const vehicle of testVehicles) {
    const plan = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: testRoutes[0].distance, polylinePoints: testRoutes[0].polylinePoints },
      chargingStations: testChargingStations
    });
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Toplam Enerji: ${plan.totalEnergyConsumedKWh} kWh, Durak Sayƒ±sƒ±: ${plan.chargingStops.length}`);
  }

  // 6. SOC Bazlƒ± Ger√ßek Uyarƒ± Testi
  console.log('\n[6] SOC Bazlƒ± Ger√ßek Uyarƒ± Testi');
  for (const vehicle of testVehicles) {
    const route = testRoutes[0];
    const lowSOCPlan = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: route.distance, polylinePoints: route.polylinePoints },
      chargingStations: testChargingStations
    });
    if (lowSOCPlan.warnings.some(w => w.toLowerCase().includes('≈üarj') || w.toLowerCase().includes('soc'))) {
      console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - D√º≈ü√ºk SOC ile uyarƒ± verildi:`, lowSOCPlan.warnings);
    } else {
      console.warn(`Ara√ß: ${vehicle.brand} ${vehicle.model} - D√º≈ü√ºk SOC ile uyarƒ± YOK!`);
    }
  }

  // 7. Geri Kazanƒ±m (Regen) Senaryosu
  console.log('\n[7] Geri Kazanƒ±m (Regen) Senaryosu');
  const regenRoute = { ...testRoutes[0], elevationData: testRoutes[0].elevationData.map((seg, i) => ({ ...seg, elevation: i === 0 ? 800 : 50 })) };
  for (const vehicle of testVehicles) {
    for (const seg of regenRoute.elevationData) {
      const energy = calculateSegmentEnergy(seg.distance, seg.elevation < 0 ? -Math.abs(seg.elevation) : seg.elevation, vehicle, defaultParams);
      if (energy < 0) {
        console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Regen aktif! Segment: distance=${seg.distance}, elevation=${seg.elevation}, enerji=${energy.toFixed(2)} kWh`);
      }
    }
  }

  // 8. Ger√ßek Rota Testi (uzun)
  console.log('\n[8] Ger√ßek Rota Testi (ƒ∞stanbul ‚Üí Ankara)');
  const longRoute = testRoutes.find(r => r.distance > 400000) || testRoutes[1];
  for (const vehicle of testVehicles) {
    const plan = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: longRoute.distance, polylinePoints: longRoute.polylinePoints },
      chargingStations: testChargingStations
    });
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Durak Sayƒ±sƒ±: ${plan.chargingStops.length}, Toplam Enerji: ${plan.totalEnergyConsumedKWh} kWh, Uyarƒ±lar:`, plan.warnings);
  }

  // 9. Yava≈ü ≈ûarj Durumu Senaryosu
  console.log('\n[9] Yava≈ü ≈ûarj Durumu Senaryosu');
  const slowStations = testChargingStations.map(station => ({ ...station, Connections: station.Connections.map(conn => ({ ...conn, PowerKW: 22 })) }));
  for (const vehicle of testVehicles) {
    const plan = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: longRoute.distance, polylinePoints: longRoute.polylinePoints },
      chargingStations: slowStations
    });
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Yava≈ü ≈üarj ile toplam s√ºre: ${plan.totalChargingTimeMinutes} dk, Uyarƒ±lar:`, plan.warnings);
  }

  // 10. Enerji/S√ºre Tradeoff Analizi
  console.log('\n[10] Enerji/S√ºre Tradeoff Analizi');
  // Kƒ±sa ama tƒ±rmanƒ±≈ülƒ± rota
  const shortHillyRoute = { ...testRoutes[0], elevationData: testRoutes[0].elevationData.map((seg, i) => ({ ...seg, elevation: i === 0 ? 0 : 500 })) };
  // Uzun ama d√ºz rota
  const longFlatRoute = { ...testRoutes[1], elevationData: testRoutes[1].elevationData.map(seg => ({ ...seg, elevation: 0 })) };
  for (const vehicle of testVehicles) {
    const shortHillyEnergy = shortHillyRoute.elevationData.reduce((sum, seg) => sum + calculateSegmentEnergy(seg.distance, seg.elevation, vehicle, defaultParams), 0);
    const longFlatEnergy = longFlatRoute.elevationData.reduce((sum, seg) => sum + calculateSegmentEnergy(seg.distance, seg.elevation, vehicle, defaultParams), 0);
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Kƒ±sa/Tƒ±rmanƒ±≈ülƒ±: ${shortHillyEnergy.toFixed(2)} kWh, Uzun/D√ºz: ${longFlatEnergy.toFixed(2)} kWh`);
  }

  // 11. Rejeneratif Frenleme Doƒürulama Testi
  console.log('\n[11] Rejeneratif Frenleme Doƒürulama Testi');
  const regenTestRoute = { ...testRoutes[0], elevationData: testRoutes[0].elevationData.map((seg, i) => ({ ...seg, elevation: i === 0 ? 1000 : 50 })) };
  for (const vehicle of testVehicles) {
    let regenFound = false;
    for (const seg of regenTestRoute.elevationData) {
      const energy = calculateSegmentEnergy(seg.distance, seg.elevation < 0 ? -Math.abs(seg.elevation) : seg.elevation, vehicle, defaultParams);
      if (energy < 0) {
        regenFound = true;
        console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Regen aktif! Segment: distance=${seg.distance}, elevation=${seg.elevation}, enerji=${energy.toFixed(2)} kWh`);
      }
    }
    if (!regenFound) {
      console.warn(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Regen aktif segment bulunamadƒ±!`);
    }
  }

  // 12. %20 Altƒ± SOC Senaryosu
  console.log('\n[12] %20 Altƒ± SOC Senaryosu');
  for (const vehicle of testVehicles) {
    const route = testRoutes[1]; // uzun rota
    const lowSOCPlan = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: route.distance, polylinePoints: route.polylinePoints },
      chargingStations: testChargingStations,
      segmentEnergies: undefined
    });
    const socWarning = lowSOCPlan.warnings.some(w => w.toLowerCase().includes('≈üarj') || w.toLowerCase().includes('soc'));
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - %15 SOC ile uzun rota, Uyarƒ±: ${socWarning ? 'VAR' : 'YOK'}, Final Batarya: %${lowSOCPlan.batteryAtDestinationPercent}`);
  }

  // 13. ≈ûarj S√ºresi ve Enerji T√ºketimi Uyumu
  console.log('\n[13] ≈ûarj S√ºresi ve Enerji T√ºketimi Uyumu');
  for (const vehicle of testVehicles) {
    const plan = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: testRoutes[1].distance, polylinePoints: testRoutes[1].polylinePoints },
      chargingStations: testChargingStations
    });
    plan.chargingStops.forEach((stop, idx) => {
      if (stop.energyChargedKWh > 0 && stop.estimatedChargeTimeMinutes <= 0) {
        console.warn(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Durak ${idx + 1}: Enerji ${stop.energyChargedKWh} kWh, S√ºre 0! HATA!`);
      }
    });
  }

  // 14. Segment Bazlƒ± SOC D√º≈ü√º≈ü√º Logu
  console.log('\n[14] Segment Bazlƒ± SOC D√º≈ü√º≈ü√º');
  for (const vehicle of testVehicles) {
    const route = testRoutes[0];
    let soc = 100;
    let socLog = `%${soc}`;
    for (const seg of route.elevationData) {
      const energy = calculateSegmentEnergy(seg.distance, seg.elevation, vehicle, defaultParams);
      const socDrop = (energy / vehicle.batteryCapacity) * 100;
      soc -= socDrop;
      socLog += ` ‚Üí %${Math.round(soc)}`;
    }
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - SOC Akƒ±≈üƒ±: ${socLog}`);
  }

  // 15. D√º≈ü√ºk Ba≈ülangƒ±√ß SOC ile Zorunlu ≈ûarj Testi
  console.log('\n[15] D√º≈ü√ºk Ba≈ülangƒ±√ß SOC ile Zorunlu ≈ûarj Testi');
  for (const vehicle of testVehicles) {
    const route = testRoutes[1]; // uzun rota
    const plan = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: route.distance, polylinePoints: route.polylinePoints },
      chargingStations: testChargingStations,
      startChargePercent: 30 // d√º≈ü√ºk SOC ile ba≈ülat
    });
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Ba≈ülangƒ±√ß SOC: %30, Durak Sayƒ±sƒ±: ${plan.chargingStops.length}`);
    plan.chargingStops.forEach((stop, idx) => {
      console.log(`  Durak ${idx + 1}: ${stop.name}, Batarya: %${stop.batteryBeforeStopPercent} ‚Üí %${stop.batteryAfterStopPercent}, Enerji: ${stop.energyChargedKWh} kWh, S√ºre: ${stop.estimatedChargeTimeMinutes} dk`);
    });
  }

  // 16. Standart %50 SOC Testi
  console.log('\n[16] Standart %50 SOC Testi');
  for (const vehicle of testVehicles) {
    const route = testRoutes[0];
    const plan = await generateChargingPlan({
      selectedVehicle: vehicle,
      routeData: { distance: route.distance, polylinePoints: route.polylinePoints },
      chargingStations: testChargingStations,
      startChargePercent: 50
    });
    console.log(`Ara√ß: ${vehicle.brand} ${vehicle.model} - Ba≈ülangƒ±√ß SOC: %50`);
    console.log(`  Durak Sayƒ±sƒ±: ${plan.chargingStops.length}`);
    console.log(`  Toplam ≈ûarj S√ºresi: ${plan.totalChargingTimeMinutes} dk`);
    console.log(`  Toplam Enerji: ${plan.totalEnergyConsumedKWh} kWh`);
    console.log(`  Varƒ±≈üta Batarya: %${plan.batteryAtDestinationPercent}`);
  }

  console.log('\nüö¶ Geli≈ümi≈ü Test Suite tamamlandƒ±!');
}; 